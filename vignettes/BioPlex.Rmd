---
vignette: >
  % \VignetteIndexEntry{Data analysis}
  % \VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
output:
  html_document:
    mathjax: null   
---

# Setup
```{r, message = FALSE}
library(BioPlex)
library(BioNet)
library(AnnotationDbi)
library(AnnotationHub)
library(EnrichmentBrowser)
library(ExpressionAtlas)
library(graph)
library(ggnetwork)
```

# Data resources

## General

Connect to 
[AnnotationHub](http://bioconductor.org/packages/AnnotationHub):

```{r ahub, message = FALSE}
ah <- AnnotationHub::AnnotationHub()
```

Connect to 
[ExperimentHub](http://bioconductor.org/packages/ExperimentHub):

```{r ehub, message = FALSE}
eh <- ExperimentHub::ExperimentHub()
```

OrgDb package for human:
```{r orgdb, message = FALSE}
ahdb <- AnnotationHub::query(ah, c("orgDb", "Homo sapiens"))
orgdb <- ahdb[[length(ahdb)]]
orgdb
keytypes(orgdb)
```

EnsDb package for human:
```{r ensdb, message = FALSE}
ahdb <- AnnotationHub::query(ah, c("ensDb", "Homo sapiens"))
ensdb <- ahdb[[length(ahdb)]]
ensdb
keytypes(ensdb)
```

## BioPlex PPIs

[Available networks](https://bioplex.hms.harvard.edu/interactions.php) include: 

- BioPlex 293T cells (versions 1.0, 2.0, and 3.0)
- BioPlex HCT116 cells (version 1.0)

Let's get the latest version of the 293T PPI network:

```{r bioplex293T}
bp.293t <- getBioPlex(cell.line = "293T", version = "3.0")
head(bp.293t)
```

```{r bioplexHCT116}
bp.hct116 <- getBioPlex(cell.line = "HCT116", version = "1.0")
head(bp.hct116)
```

### Data structures for BioPlex PPIs

We can also represent a given version of the BioPlex PPI network for a given
cell line as one big graph where bait and prey relationship are represented 
by directed edges from bait to prey.

```{r bpgraph}
bp.gr <- bioplex2graph(bp.293t)
bp.gr
head(graph::nodeData(bp.gr))
head(graph::edgeData(bp.gr))
```

## CORUM complexes

Complete set of
[CORUM](http://mips.helmholtz-muenchen.de/corum/#download) complexes:

```{r corumALL}
all <- getCorum(set = "all", organism = "Human")
dim(all)
colnames(all)
all[1:5, 1:5]
```

Core set of complexes:
```{r corumCore}
core <- getCorum(set = "core", organism = "Human")
dim(core)
```

Complexes with splice variants:
```{r corumSplice}
splice <- getCorum(set = "splice", organism = "Human")
dim(splice)
```

### Data structures for CORUM complexes 

We can represent the CORUM complexes as list of character vectors.
The names of the list are the complex IDs/names, and each element of the list is
a vector of UniProt IDs for each complex.

```{r corum2list}
core.list <- corum2list(core, subunit.id.type = "UNIPROT")
head(core.list)
length(core.list)
```

We can also represent the CORUM complexes as a list of graph instances,
where all nodes of a complex are connected to all other nodes of that complex
with undirected edges.

```{r corum2glist}
core.glist <- corum2graphlist(core, subunit.id.type = "UNIPROT")
head(core.glist)
length(core.glist)
core.glist[[1]]@graphData
graph::nodeData(core.glist[[1]])
```

We can easily convert a 
[graph](https://bioconductor.org/packages/graph) object into an 
[igraph](https://cran.r-project.org/package=igraph) object:

```{r}
ig <- igraph::graph_from_graphnel(core.glist[[4]])
ig
```

This is, for example, useful for applying `igraph`-based plotting
utilities such as 
(ggnetwork)[https://cran.r-project.org/package=igraph]:

```{r}
ggplot(ig, aes(x = x, y = y, xend = xend, yend = yend)) +
  geom_edges() +
  geom_nodelabel(aes(label = SYMBOL)) +
  theme_blank()
```

Now we can also easily pull out a BioPlex subnetwork for a CORUM complex
of interest:

```{r}
n <- graph::nodes(cdk2.glist[[1]])
bp.sgr <- graph::subGraph(n, bp.gr)
bp.sgr
```

## Transcriptome data

### HEK293 cells

#### GSE122425

##### Get RNA-seq data for HEK293 cells from GEO: 
[GSE122425](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE122425)

```{r gse122425}
gse122425 <- getGSE122425()
gse122425
head(assay(gse122425, "raw"))
head(assay(gse122425, "rpkm"))
colData(gse122425)
rowData(gse122425)
```

### HCT116 cells

#### Cancer Cell Line Encyclopedia (CCLE)

Get RNA-seq data for 934 cancer cell lines (incl. HCT116) from the 
[Cancer Cell Line Encyclopedia](https://portals.broadinstitute.org/ccle) 
as available from the [ArrayExpress-ExpressionAtlas](https://www.ebi.ac.uk/gxa) 
(Accession: [E-MTAB-2770](https://www.ebi.ac.uk/gxa/experiments/E-MTAB-2770))

```{r CCLE}
atlasRes <- ExpressionAtlas::searchAtlasExperiments(
              properties = "Cancer Cell Line Encyclopedia", 
              species = "human" )
atlasRes
ccle <- ExpressionAtlas::getAtlasData(atlasRes$Accession)
ccle <- ccle$`E-MTAB-2770`$rnaseq
ccle
```

We have raw read counts: 
```{r ccle-assay}
assay(ccle)[1:5,1:5]
colData(ccle)
```

and we have one sample per cell line:

```{r ccle-hct116}
ind <- grep("HCT 116", ccle$cell_line)
colData(ccle)[ind,]
```

#### Klijn et al., 2015

Get RNA-seq data of 675 commonly used human cancer cell lines (incl. HCT116) from [Klijn et al., 2015](https://pubmed.ncbi.nlm.nih.gov/25485619) 
as available from the [ArrayExpress-ExpressionAtlas](https://www.ebi.ac.uk/gxa) 
(Accession: [E-MTAB-2706](https://www.ebi.ac.uk/gxa/experiments/E-MTAB-2706))

```{r klijn}
klijn <- ExpressionAtlas::getAtlasData("E-MTAB-2706")
klijn <- klijn$`E-MTAB-2706`$rnaseq
klijn
```

We have raw read counts: 
```{r klijn-assay}
assay(klijn)[1:5,1:5]
colData(klijn)
```

and we have one sample per cell line:

```{r klijn-hct116}
ind <- grep("HCT 116", klijn$cell_line)
colData(klijn)[ind,]
```

Combine HCT-116 transcriptome from CCLE and Klijn et al. datasets:

```{r comb-hct116}
ind1 <- grep("HCT 116", ccle$cell_line)
ind2 <- grep("HCT 116", klijn$cell_line)
emat <- cbind(assay(ccle)[,ind1], assay(klijn)[,ind2])
colnames(emat) <- c("ccle", "klijn")
head(emat)
```

## Proteome data

### CCLE

Pull the data from ExperimentHub:
```{r ccle-proteom}
ehdb <- AnnotationHub::query(eh, c("gygi", "depmap"))
ccle.prot <- ehdb[[length(ehdb)]]
ccle.prot <- as.data.frame(ccle.prot)
```

Explore the data:
```{r ccle-proteom2}
dim(ccle.prot)
colnames(ccle.prot)
head(ccle.prot)
```

Restrict to HCT116:

```{r ccle-prot-hct116}
ccle.prot.hct116 <- subset(ccle.prot, cell_line == "HCT116_LARGE_INTESTINE")
dim(ccle.prot.hct116)
head(ccle.prot.hct116)
```

Or turn into a `SummarizedExperiment` for convenience (we can restrict
this to selected cell lines, but here we keep all cell lines):

```{r ccle-prot-se}
ccle.prot <- ccleProteome2SummarizedExperiment(ccle.prot, cell.line = NULL)
assay(ccle.prot)[1:5, 1:5]
assay(ccle.prot)[1:5, "HCT116"]
rowData(ccle.prot)
```

### Relative protein expression data (preprint)

Huttlin_BioPlex3_Table_S4.xlsx contains the relative protein expression data comparing 293T and HCT116 cells. This is a supplementary table that will be published with the upcoming BioPlex 3 paper. 

That lives on dropbox for the moment, and can be wrapped into an R data
package or uploaded to ExperimentHub. Once published there will be other
avenues to pull the data (web request, reference DB, ...).

```{r bp.prot, eval = FALSE}
bp.prot <- getBioplexProteome()
assay(bp.prot)[1:5,1:5]
colData(bp.prot)
rowData(bp.prot)
```

There are 10 channels - 5 replicates for 293T and 5 for HCT116.
Based on the way we collect these data, we end up viewing them so that they're scaled to add up to 100%.  Essentially, we think of them as ten variably-sized slices of a pie, with five each allotted to each cell line. Modeling the data this way presents some statistical complications, as I'm sure you can imagine, but it most closely aligns with how our data work.

# Downstream analysis

## BioNet

```{r deAna}
gse122425$GROUP <- rep(c(0, 1), each = 3)
gse122425 <- EnrichmentBrowser::deAna(gse122425)
```

## GGEA


## SGSeq

# Advanced 

## Caching

Note that calling functions like `getCorum` or `getBioPlex` with argument
`cache = FALSE` will automatically overwrite the corresponding object in your 
cache. It is thus typically not required for a user to interact with the cache.

For more extended control of the cache, use from within R:

```{r cache}
cache.dir <- tools::R_user_dir("BioPlex", which = "cache") 
bfc <- BiocFileCache::BiocFileCache(cache.dir)
```

and then proceed as described in the
[BiocFileCache vignette, Section 1.10](https://www.bioconductor.org/packages/release/bioc/vignettes/BiocFileCache/inst/doc/BiocFileCache.html#cleaning-or-removing-cache)
either via `cleanbfc()` to clean or `removebfc()` to remove your cache.

To do a hard reset (use with caution!):

```{r rmCache, eval = FALSE}
BiocFileCache::removebfc(bfc)
```

## SessionInfo

```{r sessionInfo}
sessionInfo()
```
